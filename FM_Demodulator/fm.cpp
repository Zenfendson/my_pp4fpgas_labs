#include <stdio.h>
#include <math.h>
#include <stdlib.h>
#include <iostream>
#include <fstream>
#include <complex>
#include <complex.h>
#include "fm.h"

using namespace std;

void linear_filter(float *b, __complex__ double *x, int fs)
{
	__complex__ double buff[64];
	for (int i=0; i<fs; i++)
	{
		for (int j=0; j<63; j++)
		{
			buff[63-j] = buff[62-j];
		}
		buff[0] = x[i];
		__complex__ double temp = 0;
		for (int j=0; j<64; j++)
		{
			temp += buff[j] *b[j];
		}
		x[i] = temp;
	}
}

void downsample_impl(__complex__ double *x, int M, __complex__ double *z)
{
	for (int i=0; i<(2400000/M); i++)
	{
		z[i] = x[M*i];
	}
}

void discrim_impl(__complex__ double *x, int fs)
{
	float b[2] = {1,-1};
	__complex__ double xr[fs];
	__complex__ double xi[fs];
	__complex__ double xro[fs];
	__complex__ double xio[fs];
	for (int i = 0; i<fs; i++)
	{
		xr[i] = __real__ x[i];
		xi[i] = __imag__ x[i];
		xro[i] = __real__ x[i];
		xio[i] = __imag__ x[i];
	}
	linear_filter(b, xr, fs); 
	linear_filter(b, xi, fs);
	for (int i = 0; i<fs; i++)
	{
		x[i] = (xro[i] * xi[i] - xio[i] * xr[i])/(xro[i]*xro[i]+xio[i]*xio[i]);
	}
}

void mono_FM_impl(__complex__ double *x, int fs, __complex__ double *z_out)
{
	float b[64] = {-0.00057098, -0.00022201,  0.0002486 ,  0.00079229,  0.00129681,
        			0.00157633,  0.00141003,  0.00063018, -0.00076622, -0.00252994,
       				-0.00414857, -0.0049459 , -0.00428825, -0.00184781,  0.00216364,
       				0.00688941,  0.01092662,  0.01264875,  0.01069752,  0.00451942,
       				-0.00521788, -0.01648693, -0.02613759, -0.03050801, -0.02629528,
       				-0.01147865,  0.01395219,  0.04768449,  0.08531217,  0.12109753,
        			0.14911115,  0.16448689,  0.16448689,  0.14911115,  0.12109753,
        			0.08531217,  0.04768449,  0.01395219, -0.01147865, -0.02629528,
       				-0.03050801, -0.02613759, -0.01648693, -0.00521788,  0.00451942,
       				0.01069752,  0.01264875,  0.01092662,  0.00688941,  0.00216364,
       				-0.00184781, -0.00428825, -0.0049459 , -0.00414857, -0.00252994,
       				-0.00076622,  0.00063018,  0.00141003,  0.00157633,  0.00129681,
        			0.00079229,  0.0002486 , -0.00022201, -0.00057098};
    
    linear_filter(b, x, fs);

	__complex__ double z[fs/10];

	downsample_impl(x,10,z);

    discrim_impl(z, fs/10);
    
    float bb[64] = {-0.00036654, -0.00013417,  0.00015024,  0.00050861,  0.0009492 ,
        			0.00145387,  0.00196926,  0.0024045 ,  0.00263739,  0.00252959,
        			0.00194958,  0.00080089, -0.00094856, -0.00324077, -0.00591034,
       				-0.00867995, -0.01117124, -0.01293192, -0.01347777, -0.01234556,
       				-0.00915132, -0.00364692,  0.00423247,  0.01433693,  0.0262916 ,
        			0.0395107 ,  0.05323597,  0.06659648,  0.07868416,  0.08863713,
        			0.09572185,  0.09940465,  0.09940465,  0.09572185,  0.08863713,
        			0.07868416,  0.06659648,  0.05323597,  0.0395107 ,  0.0262916 ,
        			0.01433693,  0.00423247, -0.00364692, -0.00915132, -0.01234556,
       				-0.01347777, -0.01293192, -0.01117124, -0.00867995, -0.00591034,
       				-0.00324077, -0.00094856,  0.00080089,  0.00194958,  0.00252959,
        			0.00263739,  0.0024045 ,  0.00196926,  0.00145387,  0.0009492 ,
        			0.00050861,  0.00015024, -0.00013417, -0.00036654};
    
    linear_filter(bb,z,fs/10);
    
    downsample_impl(z,5,z_out);

}